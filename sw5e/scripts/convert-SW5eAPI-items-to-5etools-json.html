<!DOCTYPE html>
<html lang="en">

<head>
	<title>Convert SW5eAPI JSON to 5eTools JSON</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Anonymous+Pro&family=Raleway:wght@300;400&display=swap');
		body {
			font-family: "Raleway", "Lato", sans-serif;
			font-size: 0.8em;
			background: #c1c1ca;
			color: #003;
		}
		h1, h2 {
			font-weight: 200;
		}
		h2 {
			margin: 1em 0 0;
			font-size: 3em;
		}
		label {
			font-weight: normal;
			font-size: 1.2em;
			color: #777;
		}
		input, textarea, select {
			margin: 0.25em 0 1em 0;
			padding: 0.5em;
			border-radius: 0.25em;
			border: 1px solid #222;
			background: #fdfdfd;
			font-family: 'Anonymous Pro', monospace;
			font-size: 14px;
			min-height: 20px;
		}
		textarea {
			-moz-tab-size : 4;
			-o-tab-size : 4;
				tab-size : 4;
		}
		input[type=text] {
			display: block;
			width: 100%;
		}
		select {
			display: block;
			box-sizing: content-box;
			width: 100%;
		}
		button {
			height: 3em;
			padding: 0.5em;
			margin: 0 0.1em;
			align-self: center;
			font-weight: bold;
			border-width: 1px;
		}
		section {
			margin: 0 0.5em;
		}
		section .section-wrap {
			background: #f1f1f4;
			margin: 1em 1em 1em 0;
			padding: 2.5em 2em;
			border-radius: 0.5em;
		}
		section .section-description {
			max-width: 500px;
			margin: 0 0 2em;
		}
		.from-urls {
			width: 90%;
		}
		.source-formrow {
			display: flex;
			flex-flow: row wrap;
		}
		.url-field {
			flex: 1 1 auto;
		}
		.api-urls-field {
			flex: 0 1 200px;
    		margin-left: 2em;
		}
		.from-url-section .conversion-type-selection {
    		flex-basis: 100%;
			max-height: 0;
			opacity: 0;
			transition: all 0.5s;
		}
		.conversion-type-selection.expanded {
			max-height: 7em;
			opacity: 1;
		}
		.two-panels {
			display: flex;
			flex-flow: row wrap;
			margin: 0 -1em 0 0;
			width: 100%;
		}

		.panel-left,
		.panel-right {
			flex: 1 0 auto;
			flex-flow: column nowrap;
			display: flex;
			margin: 0 1em 0 0;
		    min-width: 500px;
    		min-height: 40vh;
		}

		.panel-left label,
		.panel-right label {
			flex: 0 0 auto;
		}

		.panel-left textarea,
		.panel-right textarea {
			flex: 1 0 auto;
		}

		.convert-btn {
			background: #CCF;
		}

		.output-panel textarea {
			width: 100%;
			height: 40vh;
		}
	</style>
</head>

<body>
	<h1>SW5e JSON to 5eTools JSON Converter</h1>
	<section class="from-url-section">
		<h2>Specify JSON URLs</h2>
		<div class="section-wrap">
			<p class="section-description">The JSON from the Source URL will be converted into 5eTools JSON and then lodash _.merge'd into the object parsed
				from JSON at the Destination URL.</p>
			<div class="from-urls">
				<div class="source-formrow">
					<div class="url-field">
						<label for="sourceURL">Source URL</label>
						<input type="text" name="sourceURL" value="" />
					</div>
					<div class="api-urls-field">
						<label for="sw5eapi">Get sw5eapi URL</label>
						<select name="sw5eapi">
							<option data-conversiontype="archetype" value="https://sw5eapi.azurewebsites.net/api/archetype">Archetype</option>
							<option data-conversiontype="class" value="https://sw5eapi.azurewebsites.net/api/class">Class</option>
							<option data-conversiontype="enhancedItem" value="https://sw5eapi.azurewebsites.net/api/enhancedItem">Enhanced Item</option>
							<option data-conversiontype="equipment" value="https://sw5eapi.azurewebsites.net/api/equipment" selected>Equipment</option>
							<option data-conversiontype="feat" value="https://sw5eapi.azurewebsites.net/api/feat">Feat</option>
							<option data-conversiontype="feature" value="https://sw5eapi.azurewebsites.net/api/feature">Feature</option>
							<option data-conversiontype="monster" value="https://sw5eapi.azurewebsites.net/api/monster">Monster</option>
							<option data-conversiontype="power" value="https://sw5eapi.azurewebsites.net/api/power">Power</option>
							<option data-conversiontype="species" value="https://sw5eapi.azurewebsites.net/api/species">Species</option>
						</select>
					</div>
					<div class="conversion-type-selection">
						<label for="conversiontype">Please select a conversion type:</label>
						<select name="conversiontype">
							<option value="archetype">archetype</option>
							<option value="class">class</option>
							<option value="equipment" selected>equipment</option>
							<option value="enhancedItem">enhancedItem</option>
							<option value="feat">feat</option>
							<option value="feature">feature</option>
							<option value="monster">monster</option>
							<option value="power">power</option>
							<option value="species">species</option>
						</select>
					</div>
				</div>
				<div class="url-field">
					<label for="destinationURL">Destination URL (optional)</label>
					<input type="text" name="destinationURL" value="" />
				</div>
				<button class="convert-btn" id="convert_from_urls">Convert!</button>
				<span>Or, <a href="javascript:void(0)" id="import_from_urls">Import from URLs</a> to textareas below.</span>
			</div>
		</div>
	</section>
	<section class="paste-section">
		<h2>Paste JSON</h2>
		<div class="section-wrap">
			<p class="section-description">The JSON from the <b>left</b> panel will be converted into 5eTools JSON and then lodash _.merge'd into the object
				parsed from JSON in the <b>right</b> panel.</p>
			<div class="conversion-type-selection">
				<label for="conversiontype">Please select a conversion type:</label>
				<select name="conversiontype">
					<option value="archetype">archetype</option>
					<option value="class">class</option>
					<option value="equipment" selected>equipment</option>
					<option value="enhancedItem">enhancedItem</option>
					<option value="feat">feat</option>
					<option value="feature">feature</option>
					<option value="monster">monster</option>
					<option value="power">power</option>
					<option value="species">species</option>
				</select>
			</div>
			<div class="two-panels">
				<div class="panel-left">
					<label>SW5e API Source JSON</label>
					<textarea id="panel_left"></textarea>
				</div>
				<div class="panel-right">
					<label>5eTools Destination JSON (optional)</label>
					<textarea id="panel_right"></textarea>
				</div>
			</div>
			<button class="convert-btn" id="convert_textareas">Convert!</button>
		</div>
	</section>
	<section>
		<h2>Output</h2>
		<div class="section-wrap">
			<div class="output">
				<div class="output-panel">
					<label>Converted 5eTools JSON</label>
					<textarea id="panel_output"></textarea>
				</div>
			</div>
		</div>
	</section>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
<script>
	const sw5eAPIequipmentURL = "https://sw5eapi.azurewebsites.net/api/equipment";
	const orcgnogSW5eJsonURL = "https://raw.githubusercontent.com/orcnog/5etools-brew/main/sw5e/source/orcnogSW5e.json";
	const sourceString = "orcnogSW5e";

	/**
	 * @function
	 * @description when the sw5eapi dropdown changes, copy the selected sw5eapi dropdown value
	 * 	into the sourceURL input field and update and hide conversiontype dropdown.
	 */
	function handle_sw5eapiURL_change() {
		let sw5eapi = $('[name=sw5eapi]').val();
		let conversionType = $('[name=sw5eapi]').find(':selected').attr('data-conversiontype');
		if (sw5eapi !== 'none') {
			$('[name=sourceURL]').val(sw5eapi);
			$('.conversion-type-selection').removeClass('expanded');
			$('[name=conversiontype]').val(conversionType);
		}
	}

	/**
	 * @function
	 * @description if the input field's value is customized, clear out the sw5eapi dropdown
	 * 	and unhide conversiontype selection dropdown.
	 */
	function handle_custom_sourceURL() {
		$('[name=sw5eapi]').val('none');
		$('.conversion-type-selection').addClass('expanded');
	}

	/**
	 * @function
	 * @description if the conversion type dropdown selection changes, make sure to update both dropdowns
	 */
	 function handle_conversiontype_change() {
		let conversionType = $('[name=conversiontype]').val();
		$('[name=conversiontype]').val(conversionType);
	}

	/**
	 * @function
	 * @description grab the JSON from the two provided URLs and return it as a .then()
	 */
	function get_JSON_from_URLs() {
		let srcString;
		let destString;
		let sourceURL = $('[name=sourceURL]').val();
		let destinationURL = $('[name=destinationURL]').val();
		const getSrcJSON = $.getJSON(sourceURL).then((data) => {
			srcString = JSON.stringify(data, null, "\t");
			return srcString;
		});
		const getDestJSON = $.getJSON(destinationURL).then((data) => {
			destString = JSON.stringify(data, null, "\t");
			return destString;
		});
		return Promise.all([getSrcJSON, getDestJSON]).then((values) => {
			return values; // the final returned value of the get_JSON_from_URLS function, an array containing srcString and destString
		});
	}

	/**
	 * @function
	 * @description grab the JSON from the two provided URLs and copy it inot the "paste" textareas
	 */
	function import_JSON_from_URLs() {
		get_JSON_from_URLs().then((srcAndDestArr) => {
			$('#panel_left').val(srcAndDestArr[0]);
			$('#panel_right').val(srcAndDestArr[1]);
		});
	}

	/**
	 * @function
	 * @description grab the JSON from the two provided URLs and pass it thru the convertJSON function.
	 */
	function convert_JSON_from_URLs() {
		get_JSON_from_URLs().then((srcAndDestArr) => {
			convertJSON(srcAndDestArr[0], srcAndDestArr[1]);
		});
	}

	/**
	 * @function
	 * @description grab the JSON from the two static textareas and pass it thru the convertJSON function.
	 */
	function convert_textareas_JSON() {
		const leftString = $('#panel_left').val();
		const rightString = $('#panel_right').val();
		convertJSON(leftString, rightString);
	}

	/**
	 * @function
	 * @description Convert SW5e API JSON into valid 5eTools JSON
	 * @param {String} srcJSON source JSON
	 * @param {String} destJSON destination JSON
	 */
	function convertJSON(srcJSON, destJSON) {
		$('#panel_output').focus();
		let conversionType = $('[name=conversiontype]').val();
		let srcObj = tryParse(srcJSON);
		srcObj = reformatToValidSchema(srcObj);
		let destObj = tryParse(destJSON);
		destObj = reformatToValidSchema(destObj);

		const convertedSrcObj = create5eToolsObj(srcObj, conversionType);

		const mergedObj = mergeIntoExistingObject(destObj, convertedSrcObj);
		const mergedJSON = JSON.stringify(mergedObj, null, "\t");
		$('#panel_output').val(mergedJSON);
	}

	function reformatToValidSchema(obj) {
		if (_.isObject(obj)) {
			// if it's already a valid 5eTools homebrew object, just return it
			if (!_.isArray(obj) && 'item' in obj) {
				return obj;
			}
			// otherwise assume we need to wrap it in an object and assign to the "item" property
			return { 'item': obj };
		}
		// if it's not even parsing to an object, i mean... bail?
		console.error('Cannot parse string into a valid object.')
	}
	
	function mergeDupes (obj, prop) {
		var groupedByItem = _.groupBy(obj[prop], i => i.name);
		var itemDupes = _.pickBy(groupedByItem, x => x.length > 1);
		var itemNonDupes = _.pickBy(groupedByItem, x => x.length === 1);
		var mergedSingleItemsArray = [];
		_.values(itemDupes).forEach((arrayOfDupeItems) => {
			var mergedSingleItem = _.mergeWith(...arrayOfDupeItems, (o,s,k) => {
				if (k === 'type' && (o === 'R' || s === 'R')) return 'R' // prefer "R" (Ranged) designation if dupes contain different ones. ex: Bo-rifle
			});
			mergedSingleItemsArray.push(mergedSingleItem);
		});
		var allMerged = (_.flatMap(itemNonDupes)).concat(mergedSingleItemsArray);
		obj[prop] = allMerged;
		return obj;
	}

	function mergeIntoExistingObject(destination, incoming) {
		if (typeof destination !== "object" || typeof incoming !== "object") {
			console.error("Objects cannot be merged.");
			return;
		}
		var keyByLowercase = function (obj, key) {
			const keyedObj = _.keyBy(obj, key);
			const lowerCaseKeyedObj = _.transform(keyedObj, function (result, val, key) {
				result[key.toLowerCase()] = val;
			});
			return lowerCaseKeyedObj;
		}
		var twoDimensionalArrayHandler = function (obj, src) {
			if (_.isArray(obj)) {
				var merged = _.mergeWith(keyByLowercase(obj, 'name'), keyByLowercase(src, 'name'), function (o, s, k) {
					if (o !== undefined && (s === undefined || s === null || s === "" || s === [])) return o;
					if ((k === "weight" || k === "value") && o !== null && s === 0) return o; // for weight and value (cost) specifically, if a value already exists in destination, but incoming value is 0, defer to existing.
					return undefined;
				});
				return _.values(merged);
			}
		}
		let finalMergedObject = _.mergeWith(destination, incoming, twoDimensionalArrayHandler);
		finalMergedObject.item = _.orderBy(finalMergedObject.item, 'name', 'asc');
		return finalMergedObject;
	}

	function create5eToolsObj(obj, convtype) {
		const conversionTypeMap = {
			'archetype': 'subclass',
			'class': 'class',
			'equipment': 'item',
			'enhancedItem': 'item',
			'feat': 'feat',
			'feature': 'feature',
			'monster': 'monster',
			'power': 'spell',
			'species': 'race'
		}
		let ret = {
			"item": []
		};

		for (i = 0; i < obj.item.length; i++) {
			const newItem = convertApito5eTools(obj.item[i]);
			ret.item.push(newItem);
		}
		
		ret = mergeDupes(ret, 'item');

		return ret;
	}

	function convertApito5eTools(obj) {
		let ret = {
			"name": obj.name,
			"source": sourceString,
			"page": 0,
			"type": getItemType(obj),
			"rarity": "none",
			"age": "futuristic"
		};
		if (obj.cost) {
			ret.value = parseInt(obj.cost) * 10;
		}
		if (obj.weight && parseFloat(obj.weight) > 0) {
			ret.weight = parseFloat(obj.weight);
		}
		if (obj.description) {
			ret.entries = [
				obj.description || ""
			]
		}
		const props = getItemProperty(obj);
		if (props && props.length > 0) {
			ret.property = props;
		}
		// Weapons
		if (ret.type === "M" || ret.type === "R") {
			ret.weapon = true;
			ret.weaponCategory = obj.weaponClassification.indexOf("Martial") > -1 ? "Martial" : "Simple";
			if (obj.damageNumberOfDice && obj.damageDieType && obj.damageType) {
				ret.dmg1 = obj.damageNumberOfDice + "d" + obj.damageDieType + (obj.damageDieModifier !== 0 ? " + " + damageDieModifier : "");
				ret.dmgType = obj.damageType;
			}
			if ("Versatile" in obj.propertiesMap) {
				ret.dmg2 = obj.propertiesMap.Versatile.split(/[()]/)[1]; // get the value between parentheses, ex: 1d10
			}
			// Ranged Weapons
			if (ret.type === "R") {
				ret.firearm = true;
				ret.ammoType = "energy cell"; // possible values: "energy cell", "modern bullet", "blowgun needle|phb", "crossbow bolt|phb", "arrow|phb", "renaissance bullet", "sling bullet|phb"
				var matchAlternativeAmmo = new RegExp(/[Rr]ather than traditional power cells.*?in the form of (.*?)\./);
				if (typeof obj.description === "string") {
					var match = obj.description.match(matchAlternativeAmmo);
					if (match && match.length > 0) {
						ret.ammoType = obj.description.match(matchAlternativeAmmo)[1];
						ret.ammoType = ret.ammoType === "arrows" ? "arrow|phb" : ret.ammoType === "bolts" ? "crossbow bolts|phb" : ret.ammoType.indexOf("slug") > -1 ? 'modern bullet' : ret.ammoType;
					}
				}
				if (obj.propertiesMap) {
					Object.values(obj.propertiesMap).forEach((v) => {
						if (v.search(/\(range \d/g) > -1) {
							ret.range = (v.match(/[\d/]+/g)).join(); // filter out everything but digits and "/". Ex: "Power Cell (range 20/40)"" becomes "20/40"
						}
					});
				}
				if (obj.propertiesMap["Reload"]) {
					ret.reload = parseInt(obj.propertiesMap.Reload.split(" ")[1]); // Ex: "reload 6" returns 6
				}
			}
		}
		// Armor
		if (["HA", "MA", "LA", "S"].indexOf(ret.type) > -1) {
			ret.armor = true;
			ret.ac = obj.ac.match(/\d+/g)[0]; // Get only the AC number. Ex: filters "12 + Dex modifier (Max: 2)" to just "12".
			ret.stealth = obj.stealthDisadvantage;
			ret.strength = "Strength" in obj.propertiesMap ? parseInt(obj.propertiesMap.Strength.split(" ")[1]) : null; // Ex: "strength 11" returns 11
		}
		return ret;

		function getItemType(o) {
			// API item types:
			//	1: Ammunition 				=> AF
			//	2: Explosive				=> EXP
			//	3: Weapon					=> M or R
			//	4: Armor					=> HA, MA, LA, or S
			//	5: Storage					=> G
			//	7: Communications			=> G
			//	8: DataRecordingAndStorage	=> G
			//	9: LifeSupport				=> G
			//	10: Medical					=> G
			//	11: WeaponOrArmorAccessory	=> G
			//	12: Tool					=> AT
			//	16: Utility					=> G
			//	17: GamingSet				=> GS
			//	18: MusicalInstrument		=> INS
			//	20: Clothing				=> G
			//	21: Kit						=> T
			//	22: AlcoholicBeverage		=> FD
			//	23: Spice					=> OTH

			// 5eTools item types:
			// $: Treasure
			// A: Ammunition
			// AF: Ammunition (futuristic)
			// AIR: Vehicle (air)
			// AT: Artisan Tool
			// EM: Eldritch Machine
			// EXP: Explosive
			// FD: Food and Drink
			// G: Adventuring Gear
			// GS: Gaming Set
			// GV: Generic Variant
			// HA: Heavy Armor
			// INS: Instrument
			// LA: Light Armor
			// M: Melee Weapon
			// MA: Medium Armor
			// MNT: Mount
			// MR: Master Rune 
			// OTH: Other
			// P: Potion
			// R: Ranged Weapon
			// RD: Rod
			// RG: Ring
			// S: Shield
			// SC: Scroll
			// SCF: Spellcasting Focus
			// SHP: Vehicle (water)
			// T: Tool
			// TAH: Tack and Harness
			// TG: Trade Good
			// VEH: Vehicle (land)
			// WD: Wand
			const itemtype = o.equipmentCategoryEnum === 1 ? "AF" :
				o.equipmentCategoryEnum === 2 ? "EXP" :
				o.equipmentCategoryEnum === 3 ? (
				o.weaponClassification.indexOf("Blaster") > -1 ? "R" :
					o.weaponClassification.indexOf("Blaster") == -1 ? "M" : "") :
				o.equipmentCategoryEnum === 4 ? (
					o.armorClassification.indexOf("Heavy") > -1 ? "HA" :
					o.armorClassification.indexOf("Medium") > -1 ? "MA" :
					o.armorClassification.indexOf("Light") > -1 ? "LA" :
					o.armorClassification.indexOf("Shield") > -1 ? "S" : "") :
				o.equipmentCategoryEnum === 5 ? "G" :
				o.equipmentCategoryEnum === 7 ? "G" :
				o.equipmentCategoryEnum === 8 ? "G" :
				o.equipmentCategoryEnum === 9 ? "G" :
				o.equipmentCategoryEnum === 10 ? "G" :
				o.equipmentCategoryEnum === 11 ? "G" :
				o.equipmentCategoryEnum === 12 ? "AT" :
				o.equipmentCategoryEnum === 16 ? "G" :
				o.equipmentCategoryEnum === 17 ? "GS" :
				o.equipmentCategoryEnum === 18 ? "INS" :
				o.equipmentCategoryEnum === 20 ? "G" :
				o.equipmentCategoryEnum === 21 ? "T" :
				o.equipmentCategoryEnum === 22 ? "FD" :
				o.equipmentCategoryEnum === 23 ? "OTH" : "";
			return itemtype;
		}

		function getItemProperty(o) {
			// API item properties:
			// variable string values

			// 5eTools item properties:
			// 2H: Two-Handed
			// A: Ammunition
			// AF: Ammunition (futuristic)
			// BF: Burst Fire
			// EM: Eldritch Machine
			// F: Finesse
			// H: Heavy
			// L: Light
			// LD: Loading
			// OTH: Other
			// R: Reach
			// RLD: Reload
			// S: Special
			// T: Thrown
			// V: Versatile
			let property = [];
			if (o.equipmentCategoryEnum === 1) {
				property.push("AF");
			}
			if (!!o.propertiesMap) {
				if (o.propertiesMap["Two-Handed"]) {
					property.push("2H");
				}
				if (o.propertiesMap["Burst"]) {
					property.push("BF");
				}
				if (o.propertiesMap["Finesse"]) {
					property.push("F");
				}
				if (o.propertiesMap["Heavy"]) {
					property.push("H");
				}
				if (o.propertiesMap["Light"]) {
					property.push("L");
				}
				if (o.propertiesMap["Reach"]) {
					property.push("R");
				}
				if (o.propertiesMap["Reload"]) {
					property.push("RLD");
				}
				if (o.propertiesMap["Special"]) {
					property.push("S");
				}
				if (o.propertiesMap["Range"] && o.propertiesMap["Range"].indexOf('thrown') > -1) {
					property.push("T");
				}
				if (o.propertiesMap["Versatile"]) {
					property.push("V");
				}
			}
			return property;
		}

		function getAbilityFullWord(o) {
			const saveAbbrev = o.data.save.ability;
			let savingThrow = '';
			switch (saveAbbrev) {
				case "str":
					savingThrow = "strength";
					break;
				case "dex":
					savingThrow = "dexterity";
					break;
				case "con":
					savingThrow = "constitution";
					break;
				case "int":
					savingThrow = "intelligence";
					break;
				case "wis":
					savingThrow = "wisdom";
					break;
				case "cha":
					savingThrow = "charisma";
					break;
				default:
					savingThrow = "";
			}
			return savingThrow;
		}
	}

	function tryParse(str) {
		let json = null;
		try {
			json = JSON.parse(str);
		} catch (e) {
			console.error(e);
		}
		return json;
	}

	$(document).ready(function () {
		$('[name=sourceURL]').val(sw5eAPIequipmentURL);
		$('[name=destinationURL]').val(orcgnogSW5eJsonURL);
		$('[name=sourceURL]').on('change', handle_custom_sourceURL);
		$('[name=sw5eapi]').on('change', handle_sw5eapiURL_change);
		$('[name=conversiontype]').on('change', handle_conversiontype_change);
		$('#convert_from_urls').on('click', convert_JSON_from_URLs);
		$('#import_from_urls').on('click', import_JSON_from_URLs);
		$('#convert_textareas').on('click', convert_textareas_JSON);
	});

</script>

</html>